{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard</title>
    <link
      rel="shortcut icon"
      href="{% static 'core/img/logo2.png'%}"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="{% static '/core/css/Dashboard.css'%}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

  </head>

  <body>
    <!-- =============== Navigation ================ -->
    <div class="container">
      <div class="navigation">
        <ul>
          <li>
            <a id="Logo" href="#">
              <span class="icon">
                <img src="{% static 'core/img/logo2.png'%}" alt="" />
              </span>
              <span id="school" class="title">SchooLine</span>
            </a>
          </li>

          <li>
            <a href="#" class="nav-link" data-target="profile">
              <span class="icon">
                <ion-icon name="home-outline"></ion-icon>
              </span>
              <span class="title">حساب</span>
            </a>
          </li>

          <li>
            <a href="#" class="nav-link" data-target="messages">
              <span class="icon">
                <ion-icon name="chatbubble-outline"></ion-icon>
              </span>
              <span class="title">رسائل</span>
            </a>
          </li>

          <li>
            <a href="#" class="nav-link" data-target="settings">
              <span class="icon">
                <ion-icon name="settings-outline"></ion-icon>
              </span>
              <span class="title">اعدادات</span>
            </a>
          </li>

          <li>
            <a href="#" class="nav-link" data-target="sign-out">
              <span class="icon">
                <ion-icon name="log-out-outline"></ion-icon>
              </span>
              <span class="title">تسجيل الخروج</span>
            </a>
          </li>
        </ul>
      </div>

      <!-- ========================= Main ==================== -->
      <div class="main">
        <div class="topbar">
          <div class="toggle">
            <ion-icon name="menu-outline"></ion-icon>
          </div>

          <div class="search">
            <label>
              <input type="text" placeholder="... ابحث هنا " />
              <ion-icon name="search-outline"></ion-icon>
            </label>
          </div>

          <div class="head">
            <!-- <i class="material-symbols-outlined">account_circle</i>  -->
            <a href="{% url 'core:main' %}">       <i class="material-symbols-outlined">Home</i>  
            </a> </div>
        </div>

        <!-- ================ Content Sections ================= -->
        <div class="content">
          <div id="profile" class="section">
            <!-- ======================= Cards ================== -->
            <div class="cardBox">
            

              <div class="card">
                <div>
                  <div class="numbers">{{ nbr_courses }}</div>
                  <div class="cardName">الدورات</div>
                </div>

                <div class="iconBx">
                  <ion-icon name="cart-outline"></ion-icon>
                </div>
              </div>
              <div class="card">
                <div>
                  <div class="numbers">{{ user.credit}} <!-- Da--> </div>
                  <div class="cardName">الرصيد</div>
                </div>

                <div class="iconBx">
                  <ion-icon name="cash-outline"></ion-icon>
                </div>
              </div>
            </div>

            <!-- ================ Order Details List ================= -->
            <div class="details">
              <!-- ================= Teachers ================ -->
              <div class="recentTeachers">
                <div class="cardHeader " >
                  <h2 >الاساتذة</h2>
                </div>

                <table>
                  {%for x in teachers%}
                  <tr>
                    <td width="60px">
                      <div class="imgBx">
                        <img src="{%if x.teacher.image %}{{ x.teacher.image.url }}{%else%}#{%endif%}" alt="" />
                      </div>
                    </td>
                    <td><a href="{% url 'core:teacher' teacher_name=x.teacher.name %}">
                      <h4>
                        {{x.teacher.name}} <br />
                        <span>{{x.teacher.module}}</span>
                      </h4></a>
                    </td>
                  </tr>
                  {% empty %} <h2 style="color:#0075ff;">لا تتابع اي استاذ</h2> {%endfor%}
                </table>
              </div>
              <div class="recentCourses">
                <!-- <div class="cardHeader">
                  <h2>Recent Courses</h2>
                  <a href="#" class="btn">View All</a>
                </div> -->

                <table>
                  <thead>
                    <tr>
                      <td>الحالة</td>
                      <td>الاستاذ</td>
                      <td>الثمن</td>
                      <td>اسم الدورة</td>
                    </tr>
                  </thead>

                  <tbody>
                    
                    {%for x in courses%}
                    
                    <tr>
                      <td><span class="status {{x.status}}">{{x.status}}</span></td>
                      <td>{{x.course.teacher.name}}</td>
                      <td>{{x.course.price}}</td>
                      <td>{{x.course.name}}</td>
                    </tr>
                     {%endfor%}
                    
                    
                  </tbody>
                </table>
              </div>
            </div>
            <!-- Content for the Profile section goes here -->
          </div>

          <!-- MESSAGES ICI -->
          <div id="messages" class="section">
            <div class="message-container">
                <!-- Admin/TechTeam View -->
                {% if user.is_techteam %}
                <div class="chat-list">
                    <div class="chat-list-header">
                        <input type="text" placeholder="Search Messenger">
                    </div>
                    
                    <!-- Loop through chat threads -->
                    {% for chat_thread in chat_threads %}
                    <div class="chat-item" data-thread-id="{{ chat_thread.thread.id }}" onclick="showMessages('{{ chat_thread.thread.id }}')">
                        <div class="chat-avatar">{{ chat_thread.thread.student.username|slice:":1"|upper }}</div>
                        <div class="chat-details">
                            <div class="chat-name">{{ chat_thread.thread.student.username }}</div>
                            <div class="chat-message">{{ chat_thread.last_message.content }}</div>
                        </div>
                        <div class="chat-time">{{ chat_thread.last_message.timestamp|date:"H:i" }}</div>
                        {% if not chat_thread.last_message.is_read %}
                        <div class="chat-unread"></div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Chat Message Section -->
                <div class="container">
                    <!-- Chat Header -->
                    <div class="msg-header">
                        <div class="container1">
                            <img src="{% static 'imgs/customer02.jpg' %}" class="msgimg" />
                            <div class="active">
                                <br />
                                <p>
                                    {% if user.is_techteam %}
                                        {{ chat_thread.thread.student.username }}
                                    {% else %}
                                        Help Team
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Inbox -->
                    <div class="chat-page">
                        <div class="msg-inbox">
                            <div class="chats">
                                <!-- Message Container -->
                                {% if user.is_techteam %}
                                    {% for chat_thread in chat_threads %}
                                    <div class="msg-page" id="messages-thread-{{ chat_thread.thread.id }}" style="display: none;">
                                        <!-- Loop through all messages for the thread -->
                                        {% for message in all_messages %}
                                        {% if message.thread == chat_thread.thread %}
                                        {% if message.sender == user %}
                                        <!-- Outgoing Message -->
                                        <div class="outgoing-chats">
                                            <div class="outgoing-chats-img">
                                                <img src="{% static 'imgs/customer01.jpg' %}" />
                                            </div>
                                            <div class="outgoing-msg">
                                                <div class="outgoing-chats-msg">
                                                    <p>{{ message.content }}</p>
                                                    <span class="time">{{ message.timestamp|date:"H:i A" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <!-- Incoming Message -->
                                        <div class="received-chats">
                                            <div class="received-chats-img">
                                                <img src="{% static 'imgs/customer02.jpg' %}" />
                                            </div>
                                            <div class="received-msg">
                                                <div class="received-msg-inbox">
                                                    <p>{{ message.content }}</p>
                                                    <span class="time">{{ message.timestamp|date:"H:i A" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="msg-page" id="messages-thread-{{ chat_thread.id }}">
                                        <!-- Loop through all messages for the thread -->
                                        {% for message in all_messages %}
                                        {% if message.thread == chat_threads %}
                                        {% if message.sender == user %}
                                        <!-- Outgoing Message -->
                                        <div class="outgoing-chats">
                                            <div class="outgoing-chats-img">
                                                <img src="{% static 'imgs/customer01.jpg' %}" />
                                            </div>
                                            <div class="outgoing-msg">
                                                <div class="outgoing-chats-msg">
                                                    <p>{{ message.content }}</p>
                                                    <span class="time">{{ message.timestamp|date:"H:i A" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <!-- Incoming Message -->
                                        <div class="received-chats">
                                            <div class="received-chats-img">
                                                <img src="{% static 'imgs/customer02.jpg' %}" />
                                            </div>
                                            <div class="received-msg">
                                                <div class="received-msg-inbox">
                                                    <p>{{ message.content }}</p>
                                                    <span class="time">{{ message.timestamp|date:"H:i A" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Message Input Section -->
                        <div class="msg-bottom">
                          <form method="POST" action="{% url 'core:add_message' %}">
                            {% csrf_token %}
                            {% if user.is_techteam %}
                                <input type="hidden" name="thread_id" id="thread-id-input" value="">
                            {% endif %}
                            <div class="input-group">
                                <input
                                    type="text"
                                    class="form-control"
                                    id="message-input"
                                    name="message"
                                    placeholder="... اكتب هنا"
                                    required
                                />
                                
                                <button type="submit" class="input-group-text send-icon" id="send-button">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>let thread_id = null;

          function showMessages(threadId) {
              // Update the global thread_id variable
              thread_id = threadId;
          
              // Update the hidden input field in the form
              const threadIdInput = document.getElementById('thread-id-input');
              if (threadIdInput) {
                  threadIdInput.value = threadId;  // Set the value of the hidden input field
              }
          
              // Remove active class from all threads
              const threads = document.querySelectorAll('.chat-item');
              threads.forEach(thread => {
                  thread.classList.remove('active-thread');
              });
          
              // Add active class to the clicked thread
              const activeThread = document.querySelector(`[data-thread-id="${threadId}"]`);
              if (activeThread) {
                  activeThread.classList.add('active-thread');
              }
          
              // Hide all message containers
              const messageContainers = document.querySelectorAll('.msg-page');
              messageContainers.forEach(container => {
                  container.style.display = 'none';
              });
          
              // Show the selected thread's messages
              const selectedMessages = document.getElementById(`messages-thread-${threadId}`);
              if (selectedMessages) {
                  selectedMessages.style.display = 'block';
              }
          
              // Log the current thread_id (for debugging)
              console.log("Current thread_id:", thread_id);
          }
        </script>
          <!-- Settings -->

          <div id="settings" class="section">
            <div class="settings-page m-20 d-grid gap-20">
              <!-- Start Settings Box -->
              <div class="p-20 bg-white rad-10">
                <h2 class="mt-0 mb-10">معلومات عامة</h2>
                <p class="mt-0 mb-20 c-grey fs-15">
                 معلومات عامة حول حسابك
                </p>
                <form method="post" action="{% url 'core:change_name'%}">
                  {% csrf_token %}
                    <div class="mb-15">
                      <label class="fs-14 c-grey d-block mb-10" for="first"
                        >اسم المستخدم</label
                      >
                      <input
                        class="b-none border-ccc p-10 rad-6 d-block w-full"
                        name="username"
                        type="text"
                        id="first"
                        placeholder="Name"
                        value="{{user.username}}"
                      />
                      <input class="c-blue" type="submit" value="Change" >
                    </div>
                </form>   
                <form method="post" action="{% url 'core:change_email'%}">
                  {% csrf_token %}
                    <div>
                      <label class="fs-14 c-grey d-block mb-5" for="email"
                        >Email</label
                      >
                      <input
                        class="email b-none border-ccc p-10 rad-6 w-full mr-10"
                        name="email"
                        id="email"
                        type="email"
                        value="{{user.email}}"
                      />
                      <input class="c-blue" type="submit" value="Change" >
                    </div>
                </form>
                
              </div>
              <!-- End Settings Box -->
              <!-- Start Settings Box -->
              <div class="p-20 bg-white rad-10">
                <h2 class="mt-0 mb-10">Security Info</h2>
                <p class="mt-0 mb-20 c-grey fs-15">
                  Security Information About Your Account
                </p>
                <div class="sec-box mb-15 between-flex">

                  <form method="post" action="{% url 'core:change_password'%}">
                    {% csrf_token %}
                      <div>
                        <span>Password</span>
                                <input
                                  class="email b-none border-ccc p-10 rad-6 w-full mr-10"
                                  name="password"
                                  type="password"
                                  placeholder="new Password"
                                />
                                
                        <p class="c-grey mt-5 mb-0 fs-13">
                          Last Change On {{user.Password_last_Change}}
                        </p>
                      </div>
                      <input class="button bg-blue c-white btn-shape" type="submit" value="Change" >
                  </form>
                </div>
                <div class="sec-box mb-15 between-flex">
                  <div>
                    <span>Two-Factor Authentication</span>
                    <p class="c-grey mt-5 mb-0 fs-13">
                      Enable/Disable The Feature
                    </p>
                  </div>
                  <label>
                    <input class="toggle-checkbox" type="checkbox" checked />
                    <div class="toggle-switch"></div>
                  </label>
                </div>
                <div class="sec-box between-flex">
                  <div>
                    <span>Devices</span>
                    <p class="c-grey mt-5 mb-0 fs-13">
                      Check The Login Devices List
                    </p>
                  </div>
                  <a class="bg-eee c-black btn-shape" href="#">Devices</a>
                </div>
              </div>
              <!-- End Settings Box -->
              <!-- Start Settings Box -->
              <div class="social-boxes p-20 bg-white rad-10">
                <h2 class="mt-0 mb-10">Social Info</h2>
                <p class="mt-0 mb-20 c-grey fs-15">Social Media Information</p>
                <div class="d-flex align-center mb-15">
                  <i class="fab fa-twitter center-flex c-grey"></i>
                  <input
                    class="w-full"
                    type="text"
                    placeholder="Twitter Username"
                  />
                </div>
                <div class="d-flex align-center mb-15">
                  <i class="fab fa-facebook-f center-flex c-grey"></i>
                  <input
                    class="w-full"
                    type="text"
                    placeholder="Facebook Username"
                  />
                </div>
                <div class="d-flex align-center mb-15">
                  <i class="fab fa-linkedin center-flex c-grey"></i>
                  <input
                    class="w-full"
                    type="text"
                    placeholder="LinkedIn Username"
                  />
                </div>
                <div class="d-flex align-center">
                  <i class="fab fa-youtube center-flex c-grey"></i>
                  <input
                    class="w-full"
                    type="text"
                    placeholder="YouTube Username"
                  />
                </div>
              </div>
              <!-- End Settings Box -->
            </div>
          </div>

          <!-- Logout -->

          <div id="sign-out" class="section">
            <div class="box">
              <h1>هل أنت متأكد ؟</h1>
              <p>
                هل تريد حقا تسجيل الخروج من هذا الحساب ؟
              </p>
              <br />
              <br />
              <div class="buttons">
                <a href="#" class="nav-link" data-target="profile">رجوع </a>
                <a class="confirm" href="{% url 'core:logout'%}">تسجيل الخروج</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- =========== Scripts =========  -->
    <script src="{% static 'core/js/dashboard.js'%}"></script>
    <!-- ====== ionicons ======= -->
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
  </body>
</html>
